/* ................  .. .. ..   ... .    .                .       .       ..........................
 ............................. .....      .. .. .. . ...  . . .    .. .. ............................
 ....................................................................................................
 ........................ ..... . ................................... ... ..   ......................
 ......................+??++++++?+,...... .. ......... .. .........,+??++++++?+. ....................
 .................. ,?+=~~:::::~~=+?~.   .. ....... ......... ...~?+=~~:::::~~=+?: ..................
 .................,?+~::,,......,,:~+?:  ..     .    .      . .:?+~:,,.......,::=+?, ................
 ................~?=~:,...........,,:=++  .  ... .  . ....  ..++=:,,...........,,~=?~................
 .......... ....++~:,.. ............,,~+?.............. .....?+~:,...............,:~++. .............
 ..............++~:,.. .... ..  .. ..,,~+?..  . .... . .....?=~,,....  . .........,:~++..............
 ............ ++~:,....................,~+?. .. ...........?=~,...... .. ..........,:~++ ............
 ............~+~:,......................,~++..    ..     .++~,,....   .    .........,:=+~ ...........
 ...........,?=:,.... .. .  .. .. . ....,:=?:  ..    .   :?~:,.. .    . .. ..........,:=?............
 ...........++~,... .....................,:=?. ...... ...?=:,..  .... ............. ..,~+?...........
 ..........:+~:,.... .............. ......,~+~ .........=+~,,.........................,:~?, .........
 ..........?=~,...........................,:=?..........?=:,...........................,~=?..........
 .........,?=:,.. ........... .............,~+~ .......~+~:............................,:=?, ........
 .........++~,.. ........... ... ....  ....,:=+  .... .?=:,..........   . ..............,~+=.........
 .........?=:,...,=++~,....................,:=?.......,?=:,...:=?+=,....................,:=? ........
 .........?=:,+8D8D8888D8$..... ............:~+:......,+~:.?8DD88888D87.. ..............,:=?,........
 ........:+~=D8I~+O88888DDDO......... ......,~+=......=+~?D$~:=O888888DDO................:~?~ .......
 ........~+?DO,...:8NDD8DDDDD~ .............,~++......++7D+....:DNNND8888D:..............,~+=........
 ........++DD?....,8NNNNND88DD~  .. .... ...,:=?......?ID$.  ..~DNNNNND888D:.............,~++ .......
 ........+O88O:..,ZNNNNNNND88DD.............,:=?......IDD8~...~8NNNNNNND8888.............,~+? .......
 ........?DD8NNDDNNNNNNNNNN888D+............,:=?......7DDDN8ODNNNNNNNNNN8OO8~ ...........,~+? .......
 ........?D8DNNNNNNNNNNNNNNDOO87............,:=?......$DDNNNNNNNNNNNNNNNNOOOI............,~+? .......
 ........+D8DNNNNNNNNNNNNNNNZOO7............,:=+......$D8NNNNNNNNNNNNNNNNZZO7............,~++........
 ........=D8DNNNNNNNNNNNNNND$Z8?............,:++......ID8DNNNNNNNNNNNNNNN7$O+............,~+= .......
 ........:888NNNNNNNNNNNNNM$7$8:............,~++ .....=D88NNNNNNNNNNNNNMZ7$Z.............:~+~ .......
 .........$8OONNNNNNNNNNNM$I7Z7.............,~+: .....:$88ONNNNNNNNNNNM$?I$I............,:=?,........
 .........?OOZ$8NMNNNNNM8??I$O.............,:=?.......,?8OOZDMMNNNNNM8???7$.............,:=?.........
 .........++$OZ$77$ZZ$I???IZI..............,~=+ ...... ?=Z8Z$77$ZZ7?+??IZ?..............,~+= ........
 .........,?==OZ$77IIIII7Z$................:~+~........~+~+8O$77IIIII7Z$...............,:=?, ........
 ..........++~,.IZZZZZ$I,.. ..............,:=?. ........?=:,.?ZOOOZ$?.. ...............,~=?..........
 ..........:?~:,..........................,~+=..........=+~:..........................,:~?, .........
 ...........++~,.........................,:=?............?=:,.. ......................,~+?...........
 ...........,?=:,.......................,:~?:............~+~:,.......................,:=?. ..........
 ............~?~:,......................,~++..............++~,,.. ..................,:~+~ ...........
 ............ ++~:,.. .................,~=?................?+~,... ................,:~++.............
 ..............?+~:,... ..............,~=?..................?=~,,.. ..............,:~++..............
 ...............++~:,...............,:~+?. ..................?+~:,...............,:~++  .............
 ................=?=~,,............,:=++......................?+~:,,.... ......,,~=?= ...............
 ................ ,?+=~:,.......,,:~+?:  ..................... :?+~::,,.....,,:~=+?. ................
 ...................:?+=~~::::::~=+?=............................=?+=~~:::::~~=+?: ..................
 ......................=??++++++?+,................................,???+++++??=......................
 ....................... ..,,,.. .................................... .,,,,..........................
 ..................................... ..............................................................
 ....................................................................................................
 ..........................................................................     . .      . . .  . .*/

import Pusher from 'pusher-js';

// Enable pusher logging - don't include this in production
Pusher.logToConsole = true;

const pusher = new Pusher('376e191843d5a9dfbb33', {
  cluster: 'eu',
  encrypted: true,
  authEndpoint: 'https://magic-wedpajtcyc.now.sh/pusher/auth',
});

const channel = pusher.subscribe('private-chat');

const GIF_ENDPOINT = 'http://api.giphy.com/v1/gifs/random?api_key=dc6zaTOxFJmzC&tag=';
const messages = [];
const callbacks = [];

channel.bind('pusher:subscription_succeeded', function() {

  channel.bind('client-message', function(msg) {
    messages.push(msg);
    callbacks.forEach(cb => cb([...messages].reverse()));
  });

});

export function sendMessage(name, message = '') {
  function getJSON(response) {
    return response.json();
  }

  function send(json) {
    const image = json.data.image_original_url;
    const msg = {name, message, image};

    channel.trigger('client-message', msg);
    messages.push(msg);
    callbacks.forEach(cb => cb([...messages].reverse()));
  }

  fetch(GIF_ENDPOINT + encodeURIComponent(message))
    .then(getJSON)
    .then(send);
}

export function subscribe(callback) {
  callback([]);
  callbacks.push(callback);
}

